<div class="container-fluid py-4 bg-light min-vh-100">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4 pb-4 border-bottom border-2 border-primary border-opacity-25">
            <h1 class="h2 mb-1 text-dark fw-bold">
            <i class="menu-icon fas fa-shopping-cart text-primary"></i>
                Gestión de Pedidos
            </h1>
          </div>            
            <div *ngIf="estadisticas && !cargandoEstadisticas" class="row g-3">
            <!-- Total de pedidos -->
            <div class="col-lg-3 col-md-6">
              <div class="card text-center shadow-sm border-0">
                <div class="card-body">
                  <div class="text-primary mb-2">
                    <i class="fas fa-box-open fa-2x"></i>
                  </div>
                  <div class="fs-3 fw-bold text-dark">{{ estadisticas.total_pedidos }}</div>
                  <div class="text-muted small fw-semibold">Total de pedidos</div>
                </div>
              </div>
            </div>

            <!-- Pendientes -->
            <div class="col-lg-3 col-md-6">
              <div class="card text-center shadow-sm border-0">
                <div class="card-body">
                  <div class="text-warning mb-2">
                    <i class="fas fa-clock fa-2x"></i>
                  </div>
                  <div class="fs-3 fw-bold text-dark">{{ estadisticas.pendientes }}</div>
                  <div class="text-muted small fw-semibold">Pendientes</div>
                </div>
              </div>
            </div>

            <!-- Pagados -->
            <div class="col-lg-3 col-md-6">
              <div class="card text-center shadow-sm border-0">
                <div class="card-body">
                  <div class="text-success mb-2">
                    <i class="fas fa-check-circle fa-2x"></i>
                  </div>
                  <div class="fs-3 fw-bold text-dark">{{ estadisticas.pagados }}</div>
                  <div class="text-muted small fw-semibold">Pagados</div>
                </div>
              </div>
            </div>

            <!-- Monto total -->
            <div class="col-lg-3 col-md-6">
              <div class="card text-center shadow-sm border-0">
                <div class="card-body">
                  <div class="text-info mb-2">
                    <i class="fas fa-dollar-sign fa-2x"></i>
                  </div>
                  <div class="fs-3 fw-bold text-dark">{{ formatearMoneda(estadisticas.monto_total) }}</div>
                  <div class="text-muted small fw-semibold">Monto total</div>
                </div>
              </div>
            </div>
          </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h6 class="card-title text-dark fw-bold mb-3">
        <i class="fas fa-filter text-primary me-2"></i>
        Filtros de búsqueda
      </h6>

      <div class="row row-cols-lg-6 row-cols-md-3 row-cols-2 g-3">
        <!-- Búsqueda -->
        <div class="col">
          <label class="form-label small fw-semibold text-muted">
            <i class="fas fa-search me-1"></i> Buscar:
          </label>
          <input
            type="text"
            class="form-control form-control-sm"
            placeholder="Cliente, DNI, email..."
            [(ngModel)]="filtros.buscar"
            (keyup.enter)="aplicarFiltros()"
          />
        </div>

        <!-- Estado -->
        <div class="col">
          <label class="form-label small fw-semibold text-muted">Estado:</label>
          <select class="form-select form-select-sm" [(ngModel)]="filtros.estado">
            <option *ngFor="let estado of estadosDisponibles" [value]="estado.valor">
              {{ estado.etiqueta }}
            </option>
          </select>
        </div>

        <!-- Fecha desde -->
        <div class="col">
          <label class="form-label small fw-semibold text-muted">Desde:</label>
          <input
            type="date"
            class="form-control form-control-sm"
            [(ngModel)]="filtros.fecha_desde"
          />
        </div>

        <!-- Fecha hasta -->
        <div class="col">
          <label class="form-label small fw-semibold text-muted">Hasta:</label>
          <input
            type="date"
            class="form-control form-control-sm"
            [(ngModel)]="filtros.fecha_hasta"
          />
        </div>

        <!-- Monto mínimo -->
        <div class="col">
          <label class="form-label small fw-semibold text-muted">Monto mín:</label>
          <input
            type="number"
            class="form-control form-control-sm"
            placeholder="0.00"
            [(ngModel)]="filtros.monto_min"
            min="0"
            step="0.01"
          />
        </div>

        <!-- Monto máximo -->
        <div class="col">
          <label class="form-label small fw-semibold text-muted">Monto máx:</label>
          <input
            type="number"
            class="form-control form-control-sm"
            placeholder="0.00"
            [(ngModel)]="filtros.monto_max"
            min="0"
            step="0.01"
          />
        </div>
      </div>

      <!-- Botones -->
      <div class="border-top pt-3 mt-3 d-flex justify-content-end gap-2">
        <button class="btn btn-primary btn-sm px-3" (click)="aplicarFiltros()">
          <i class="fas fa-filter me-1"></i> Buscar
        </button>
        <button class="btn btn-outline-secondary btn-sm px-3" (click)="limpiarFiltros()">
          <i class="fas fa-eraser me-1"></i> Limpiar
        </button>
      </div>
    </div>
    </div>


    <!-- Loading -->
    <div *ngIf="cargando" class="card shadow-sm border-0">
        <div class="card-body text-center py-5">
            <div class="loading-spinner mx-auto mb-4"></div>
            <h5 class="text-primary mb-2">Cargando pedidos...</h5>
            <p class="text-muted small mb-0">Esto puede tardar unos segundos</p>
        </div>
    </div>

    <!-- Error -->
    <div *ngIf="error && !cargando" class="card shadow-sm border-0 border-start border-danger border-4">
        <div class="card-body text-center py-5">
            <div class="text-danger mb-4">
                <i class="fas fa-exclamation-triangle fs-1 mb-3 d-block"></i>
                <h5>Oops! Algo salió mal</h5>
                <p class="mb-0">{{ error }}</p>
            </div>
            <button class="btn btn-primary" (click)="cargarPedidos()">
                <i class="fas fa-refresh me-1"></i>
                Reintentar
            </button>
        </div>
    </div>

    <!-- Tabla de pedidos -->
    <div *ngIf="!cargando && !error" class="card shadow-sm border-0">
        <!-- Info de resultados -->
        <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center flex-wrap gap-3 py-3">
            <div class="d-flex align-items-center gap-2">
              <i class="fas fa-chart-bar"></i>
              <span class="fw-medium">
                  Mostrando {{ pedidos.length }} de {{ totalPedidos }} pedidos
              </span>
            </div>
        </div>

        <!-- Tabla -->
        <div class="table-responsive">
  <table class="table table-hover mb-0 align-middle">
  <thead class="table-dark">
    <tr>
      <th scope="col" class="text-center" style="width: 90px;">
        ID
      </th>
      <th scope="col" style="min-width: 180px;">
        <i class="fas fa-user me-1"></i> Cliente
      </th>
      <th scope="col" class="text-center" style="width: 120px;">
        <i class="fas fa-dollar-sign me-1"></i> Total
      </th>
      <th scope="col" class="text-center" style="width: 120px;">
        <i class="fas fa-boxes me-1"></i> Productos
      </th>
      <th scope="col" class="text-center" style="width: 140px;">
        <i class="fas fa-clipboard-check me-1"></i> Estado
      </th>
      <th scope="col" class="text-center" style="width: 140px;">
        <i class="fas fa-credit-card me-1"></i> Pago
      </th>
      <th scope="col" class="text-center" style="width: 170;">
        <i class="fas fa-calendar me-1"></i> Fecha
      </th>
      <th scope="col" class="text-center" style="width: 120px;">
        <i class="fas fa-cogs"></i>
      </th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let pedido of pedidos" class="pedido-row">
      
      <!-- ID -->
      <td class="text-center">
        <span class="badge bg-light text-dark border">
          PED-{{ pedido.id }}
        </span>
      </td>

      <!-- Cliente -->
      <td>
        <div class="fw-bold text-dark mb-1 small">
          {{ pedido.cliente.nombre }}
        </div>
        <div class="text-muted small">
          <div>
            <i class="fas fa-id-card me-1"></i>{{ pedido.cliente.dni }}
          </div>
          <div>
            <i class="fas fa-envelope me-1"></i>{{ pedido.cliente.email }}
          </div>
        </div>
      </td>


      <!-- Total -->
      <td class="text-center">
        <span class="fw-bold text-success">
          {{ formatearMoneda(pedido.total) }}
        </span>
      </td>

      <!-- Cantidad de productos -->
      <td class="text-center">
        <span class="badge bg-info-subtle text-dark border">
          {{ pedido.cantidad_items }} ítems
        </span>
      </td>

      <!-- Estado del pedido -->
      <td class="text-center">
        <span
            class="badge estado-badge px-3"
            [class]="getEstadoClase(pedido.estado_pedido)"
          >
            {{ pedido.estado_pedido | titlecase }}
          </span>

        <div
          *ngIf="estaEditandoEstado(pedido.id)"
          class="spinner-border spinner-border-sm text-primary mt-1"
          role="status"
        >
          <span class="visually-hidden">Cargando...</span>
        </div>
      </td>

      <!-- Estado del pago -->
      <td class="text-center">
        <span
          class="badge px-3"
          [class.bg-success]="pedido.tiene_pago_aprobado"
          [class.bg-danger]="!pedido.tiene_pago_aprobado"
        >
          <i [class]="pedido.tiene_pago_aprobado ? 'fas fa-check-circle' : 'fas fa-times-circle'" class="me-1"></i>
          {{ pedido.tiene_pago_aprobado ? 'Aprobado' : 'Pendiente' }}
        </span>

        <div *ngIf="pedido.metodos_pago.length > 0" class="mt-1">
          <span
            *ngFor="let metodo of pedido.metodos_pago"
            class="badge bg-secondary-subtle text-dark border me-1"
            style="font-size: 0.65rem;"
          >
            {{ metodo }}
          </span>
        </div>
      </td>

      <!-- Fecha -->
      <td class="text-center">
        <div class="text-muted small font-monospace">
          <div>{{ formatearFecha(pedido.fecha_pedido) }}</div>
        </div>
      </td>

      <!-- Acciones -->
      <td class="text-center">
        <div class="btn-group" role="group">
          <button
            class="btn btn-info btn-sm"
            (click)="verDetallePedido(pedido.id)"
            title="Ver detalles"
          >
            <i class="fas fa-eye"></i>
          </button>
        </div>
      </td>
    </tr>

    <!-- Estado vacío -->
    <tr *ngIf="pedidos.length === 0">
      <td colspan="8" class="text-center py-5">
        <div class="empty-state">
          <h4 class="text-muted mb-3">No hay pedidos disponibles</h4>
          <p class="text-muted mb-4">
            No se encontraron pedidos que coincidan con los filtros aplicados.
            <br>
            <small>Intenta ajustar los criterios de búsqueda o mostrar todos los pedidos.</small>
          </p>
          <div class="d-flex gap-2 justify-content-center">
            <button class="btn btn-outline-primary" (click)="limpiarFiltros()">
              <i class="fas fa-eye me-1"></i>
              Ver todos los pedidos
            </button>
          </div>
        </div>
      </td>
    </tr>
  </tbody>
</table>

</div>


        <!-- Paginación -->
        <div *ngIf="paginacion && paginacion.last_page > 1" class="card-footer bg-light border-0">
          <nav aria-label="Paginación de pedidos" class="d-flex justify-content-center">
              <ul class="pagination mb-0">
                  
                  <!-- Primera página -->
                  <li class="page-item" [class.disabled]="paginacion.current_page === 1">
                      <button class="page-link" 
                              [disabled]="paginacion.current_page === 1"
                              (click)="cambiarPagina(1)">
                          <i class="fas fa-angle-double-left"></i>
                      </button>
                  </li>

                  <!-- Anterior -->
                  <li class="page-item" [class.disabled]="paginacion.current_page === 1">
                      <button class="page-link" 
                              [disabled]="paginacion.current_page === 1"
                              (click)="cambiarPagina(paginacion.current_page - 1)">
                          <i class="fas fa-angle-left"></i>
                          Anterior
                      </button>
                  </li>

                  <!-- Números de página -->
                  <ng-container *ngFor="let pagina of getPaginasVisibles()">
                      <li *ngIf="pagina !== -1" 
                          class="page-item" 
                          [class.active]="pagina === paginacion.current_page">
                          <button class="page-link fw-bold" (click)="cambiarPagina(pagina)">
                              {{ pagina }}
                          </button>
                      </li>
                      <li *ngIf="pagina === -1" class="page-item disabled">
                          <span class="page-link">...</span>
                      </li>
                  </ng-container>

                  <!-- Siguiente -->
                  <li class="page-item" [class.disabled]="paginacion.current_page === paginacion.last_page">
                      <button class="page-link" 
                              [disabled]="paginacion.current_page === paginacion.last_page"
                              (click)="cambiarPagina(paginacion.current_page + 1)">
                          Siguiente
                          <i class="fas fa-angle-right"></i>
                      </button>
                  </li>

                  <!-- Última página -->
                  <li class="page-item" [class.disabled]="paginacion.current_page === paginacion.last_page">
                      <button class="page-link" 
                              [disabled]="paginacion.current_page === paginacion.last_page"
                              (click)="cambiarPagina(paginacion.last_page)">
                          <i class="fas fa-angle-double-right"></i>
                      </button>
                  </li>
              </ul>
          </nav>
        </div>

    </div>
</div>

<!-- Modal de detalle del pedido -->
<div *ngIf="mostrarModal" class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);" (click)="cerrarModal()">
    <div class="modal-dialog modal-xl modal-dialog-scrollable modal-dialog-centered" (click)="$event.stopPropagation()">
        <div class="modal-content shadow-lg border-0">
            <!-- Header del modal -->
            <div class="modal-header border-0 " style="background: #667eea;">
                <div class="d-flex align-items-center text-white">
                    <i class="fas fa-receipt fs-4 me-3"></i>
                    <div>
                      <h4 class="modal-title fw-semibold">
                        Detalles del Pedido {{ pedidoDetalle?.id ? 'PED-' + pedidoDetalle?.id : '' }}
                    </h4>
                        <small class="opacity-75" *ngIf="pedidoDetalle">
                            {{ formatearFecha(pedidoDetalle.fecha_pedido) }}
                        </small>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" (click)="cerrarModal()" aria-label="Close"></button>
            </div>

            <!-- Loading del modal -->
            <div *ngIf="cargandoDetalle" class="modal-body text-center py-5">
                <div class="d-flex flex-column align-items-center">
                    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h6 class="text-muted mb-1">Cargando detalles del pedido...</h6>
                    <small class="text-muted">Por favor espere un momento</small>
                </div>
            </div>

            <!-- Error del modal -->
            <div *ngIf="errorDetalle && !cargandoDetalle" class="modal-body text-center py-5">
                <div class="d-flex flex-column align-items-center">
                    <div class="bg-danger bg-opacity-10 rounded-circle p-3 mb-3">
                        <i class="fas fa-exclamation-triangle text-danger fs-1"></i>
                    </div>
                    <h5 class="text-danger mb-3">Error al cargar los detalles</h5>
                    <p class="text-muted mb-4">{{ errorDetalle }}</p>
                    <button class="btn btn-outline-primary" (click)="cargarDetallePedido(pedidoSeleccionado!)">
                        <i class="fas fa-redo me-2"></i>
                        Reintentar
                    </button>
                </div>
            </div>

            <!-- Contenido del modal -->
            <div *ngIf="pedidoDetalle && !cargandoDetalle && !errorDetalle" class="modal-body p-4">
                
                <!-- Badge de Estado Principal -->
                <div class="text-center mb-4">
                  <span class="badge fs-6 px-4 py-2 rounded-pill"
                        [ngClass]="getEstadoClase(pedidoDetalle.estado_pedido)">
                    <i class="fas fa-circle me-2" style="font-size: 0.5em;"></i>
                    {{ pedidoDetalle.estado_pedido | titlecase }}
                  </span>
                </div>

                <!-- Tarjetas de Información -->
                <div class="row g-4">
                    
                    <!-- Información del Cliente -->
                    <div class="col-lg-6">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-header bg-transparent border-0 pb-0">
                                <div class="d-flex align-items-center">
                                    <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                                        <i class="fas fa-user text-primary"></i>
                                    </div>
                                    <h6 class="mb-0 fw-semibold">Información del Cliente</h6>
                                </div>
                            </div>
                            <div class="card-body pt-3">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <div class="d-flex align-items-start">
                                            <i class="fas fa-user-circle text-muted me-2 mt-1"></i>
                                            <div class="flex-grow-1">
                                                <small class="text-muted d-block">Nombre completo</small>
                                                <span class="fw-medium">{{ pedidoDetalle.cliente.nombre }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="d-flex align-items-start">
                                            <i class="fas fa-id-card text-muted me-2 mt-1"></i>
                                            <div class="flex-grow-1">
                                                <small class="text-muted d-block">DNI</small>
                                                <span class="fw-medium">{{ pedidoDetalle.cliente.dni }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="d-flex align-items-start">
                                            <i class="fas fa-phone text-muted me-2 mt-1"></i>
                                            <div class="flex-grow-1">
                                                <small class="text-muted d-block">Teléfono</small>
                                                <span class="fw-medium">{{ pedidoDetalle.cliente.telefono || 'No registrado' }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="d-flex align-items-start">
                                            <i class="fas fa-envelope text-muted me-2 mt-1"></i>
                                            <div class="flex-grow-1">
                                                <small class="text-muted d-block">Email</small>
                                                <span class="fw-medium text-break">{{ pedidoDetalle.cliente.email }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="d-flex align-items-start">
                                            <i class="fas fa-map-marker-alt text-muted me-2 mt-1"></i>
                                            <div class="flex-grow-1">
                                                <small class="text-muted d-block">Dirección de envío</small>
                                                <span class="fw-medium">{{ pedidoDetalle.direccion_envio }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resumen del Pedido -->
                    <div class="col-lg-6">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-header bg-transparent border-0 pb-0">
                                <div class="d-flex align-items-center">
                                    <div class="bg-success bg-opacity-10 rounded-circle p-2 me-3">
                                        <i class="fas fa-shopping-cart text-success"></i>
                                    </div>
                                    <h6 class="mb-0 fw-semibold">Resumen del Pedido</h6>
                                </div>
                            </div>
                            <div class="card-body pt-3">
                                <div class="row g-3">
                                    <div class="col-sm-6">
                                        <div class="text-center p-3 bg-light rounded">
                                            <i class="fas fa-dollar-sign text-success fs-4 mb-2 d-block"></i>
                                            <small class="text-muted d-block">Total del pedido</small>
                                            <h5 class="mb-0 text-success fw-bold">{{ formatearMoneda(pedidoDetalle.total) }}</h5>
                                        </div>
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="text-center p-3 bg-light rounded">
                                            <i class="fas fa-box text-primary fs-4 mb-2 d-block"></i>
                                            <small class="text-muted d-block">Total de productos</small>
                                            <h5 class="mb-0 text-primary fw-bold">{{ pedidoDetalle.items?.length }} items</h5>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                            <span class="text-muted">
                                                <i class="fas fa-calendar-plus me-2"></i>
                                                Fecha del pedido
                                            </span>
                                            <span class="fw-medium font-monospace small">{{ formatearFecha(pedidoDetalle.fecha_pedido) }}</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center py-2">
                                            <span class="text-muted">
                                                <i class="fas fa-sync-alt me-2"></i>
                                                Última actualización
                                            </span>
                                            <span class="fw-medium font-monospace small">{{ formatearFecha(pedidoDetalle.ultima_actualizacion) }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Items del pedido -->
                <div class="card mt-4 border-0 shadow-sm">
                    <div class="card-header bg-transparent border-0 pb-0">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <div class="bg-info bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="fas fa-box text-info"></i>
                                </div>
                                <h6 class="mb-0 fw-semibold">Productos del Pedido</h6>
                            </div>
                            <span class="badge bg-info rounded-pill">{{ pedidoDetalle.items?.length }} items</span>
                        </div>
                    </div>
                    <div class="card-body pt-3">
                        <div class="row g-3">
                            <div *ngFor="let item of pedidoDetalle.items; let i = index" class="col-12">
                                <div class="border rounded p-3 position-relative overflow-hidden" 
                                     [style.border-left]="'4px solid ' + (i % 2 === 0 ? '#0d6efd' : '#20c997') + ' !important'">
                                    <div class="row align-items-center g-3">
                                        <div class="col-auto">
                                            <div class="position-relative">
                                                <img 
                                                    [src]="getImagenProducto(item.producto)" 
                                                    alt="{{ item.producto.nombre }}" 
                                                    (error)="handleImgError($event)"
                                                    class="rounded shadow-sm"
                                                    style="width: 70px; height: 70px; object-fit: cover;"
                                                />
                                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-primary">
                                                    {{ item.cantidad }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <h6 class="mb-1 fw-semibold">{{ item.producto.nombre }}</h6>
                                                    <div class="d-flex align-items-center mb-2">
                                                        <small class="text-muted me-2">SKU:</small>
                                                        <code class="bg-light px-2 py-1 rounded small">{{ item.producto.sku }}</code>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="row text-end text-md-start g-2">
                                                        <div class="col-4 col-md-12">
                                                            <small class="text-muted d-block">Precio unitario</small>
                                                            <span class="fw-medium">{{ formatearMoneda(item.precio_venta) }}</span>
                                                        </div>
                                                        <div class="col-4 col-md-12">
                                                            <small class="text-muted d-block">Cantidad</small>
                                                            <span class="fw-medium">{{ item.cantidad }} unidades</span>
                                                        </div>
                                                        <div class="col-4 col-md-12">
                                                            <small class="text-muted d-block">Subtotal</small>
                                                            <strong class="text-success fs-6">{{ formatearMoneda(item.subtotal) }}</strong>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Información de pagos -->
                <div class="card mt-4 border-0 shadow-sm" *ngIf="pedidoDetalle.pagos && pedidoDetalle.pagos.length > 0">
                    <div class="card-header bg-transparent border-0 pb-0">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <div class="bg-warning bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="fas fa-credit-card text-warning"></i>
                                </div>
                                <h6 class="mb-0 fw-semibold">Información de Pagos</h6>
                            </div>
                            <span class="badge bg-warning text-dark rounded-pill">{{ pedidoDetalle.pagos.length }} pago(s)</span>
                        </div>
                    </div>
                    <div class="card-body pt-3">
                        <div class="row g-3">
                            <div *ngFor="let pago of pedidoDetalle.pagos" class="col-md-6">
                                <div class="card border-0 bg-light">
                                    <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center pb-2">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-credit-card text-primary me-2"></i>
                                            <span class="fw-semibold">{{ pago.metodo_pago | titlecase }}</span>
                                        </div>
                                        <span class="badge" [class]="getPagoEstadoClase(pago.estado_pago)">
                                            {{ getPagoEstadoTexto(pago.estado_pago) }}
                                        </span>
                                    </div>
                                    <div class="card-body pt-0">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <small class="text-muted">Monto:</small>
                                            <span class="fw-bold text-success">{{ formatearMoneda(pago.monto) }} {{ pago.moneda }}</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <small class="text-muted">Fecha:</small>
                                            <span class="font-monospace small">{{ formatearFecha(pago.fecha_pago) }}</span>
                                        </div>
                                        <div *ngIf="pago.culqi_charge_id" class="mt-2">
                                            <small class="text-muted d-block mb-1">ID de transacción:</small>
                                            <div class="d-flex align-items-center">
                                                <code class="bg-white px-2 py-1 rounded flex-grow-1 small text-break">{{ pago.culqi_charge_id }}</code>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Footer del modal -->
            <div *ngIf="!cargandoDetalle && !errorDetalle" class="modal-footer border-0 bg-light">
                <!-- Cambio de estado -->
                <div class="d-flex align-items-center flex-wrap gap-3 me-auto" *ngIf="pedidoDetalle && puedeEditarEstado(pedidoDetalle)">
                    <div class="d-flex align-items-center gap-2">
                        <i class="fas fa-edit text-primary"></i>
                        <label class="form-label mb-0 fw-medium">Cambiar estado:</label>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <select 
                            class="form-select"
                            style="width: 200px;"
                            [(ngModel)]="nuevoEstado"
                            [disabled]="cargandoEstado"
                        >
                            <option [value]="pedidoDetalle.estado_pedido">{{ getEstadoTexto(pedidoDetalle.estado_pedido) }} (Actual)</option>
                            <option *ngFor="let estado of getEstadosDisponibles(pedidoDetalle.estado_pedido)" [value]="estado.valor">
                                {{ estado.etiqueta }}
                            </option>
                        </select>
                        <button 
                            class="btn btn-primary"
                            [disabled]="nuevoEstado === pedidoDetalle.estado_pedido || cargandoEstado"
                            (click)="actualizarEstadoPedido(pedidoDetalle.id, nuevoEstado)"
                        >
                            <span *ngIf="cargandoEstado">
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                Actualizando...
                            </span>
                            <span *ngIf="!cargandoEstado">
                                <i class="fas fa-save me-2"></i>
                                Actualizar
                            </span>
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>