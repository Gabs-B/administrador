<div class="container-fluid py-4 bg-light min-vh-100">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5 fw-bold text-dark mb-3">Gestión de Pedidos</h1>
            
            <!-- Estadísticas rápidas -->
            <div *ngIf="estadisticas && !cargandoEstadisticas" class="row g-3">
                <div class="col-lg-3 col-md-6">
                    <div class="card text-center shadow-sm">
                        <div class="card-body">
                            <div class="stat-numero text-primary">{{ estadisticas.total_pedidos }}</div>
                            <div class="text-muted small fw-medium">Total</div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="card text-center shadow-sm">
                        <div class="card-body">
                            <div class="stat-numero text-primary">{{ estadisticas.pendientes }}</div>
                            <div class="text-muted small fw-medium">Pendientes</div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="card text-center shadow-sm">
                        <div class="card-body">
                            <div class="stat-numero text-primary">{{ estadisticas.pagados }}</div>
                            <div class="text-muted small fw-medium">Pagados</div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="card text-center shadow-sm">
                        <div class="card-body">
                            <div class="stat-numero text-primary">{{ formatearMoneda(estadisticas.monto_total) }}</div>
                            <div class="text-muted small fw-medium">Monto Total</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <!-- Búsqueda -->
                <div class="col-lg-2 col-md-4 col-sm-6">
                    <label class="form-label small fw-medium text-secondary">Buscar:</label>
                    <input
                        type="text"
                        class="form-control form-control-sm"
                        placeholder="Cliente, DNI, email..."
                        [(ngModel)]="filtros.buscar"
                        (keyup.enter)="aplicarFiltros()"
                    />
                </div>

                <!-- Estado -->
                <div class="col-lg-2 col-md-4 col-sm-6">
                    <label class="form-label small fw-medium text-secondary">Estado:</label>
                    <select class="form-select form-select-sm" [(ngModel)]="filtros.estado">
                        <option *ngFor="let estado of estadosDisponibles" [value]="estado.valor">
                            {{ estado.etiqueta }}
                        </option>
                    </select>
                </div>

                <!-- Fecha desde -->
                <div class="col-lg-2 col-md-4 col-sm-6">
                    <label class="form-label small fw-medium text-secondary">Desde:</label>
                    <input
                        type="date"
                        class="form-control form-control-sm"
                        [(ngModel)]="filtros.fecha_desde"
                    />
                </div>

                <!-- Fecha hasta -->
                <div class="col-lg-2 col-md-4 col-sm-6">
                    <label class="form-label small fw-medium text-secondary">Hasta:</label>
                    <input
                        type="date"
                        class="form-control form-control-sm"
                        [(ngModel)]="filtros.fecha_hasta"
                    />
                </div>

                <!-- Monto mínimo -->
                <div class="col-lg-1 col-md-4 col-sm-6">
                    <label class="form-label small fw-medium text-secondary">Monto mín:</label>
                    <input
                        type="number"
                        class="form-control form-control-sm"
                        placeholder="0.00"
                        [(ngModel)]="filtros.monto_min"
                        min="0"
                        step="0.01"
                    />
                </div>

                <!-- Monto máximo -->
                <div class="col-lg-1 col-md-4 col-sm-6">
                    <label class="form-label small fw-medium text-secondary">Monto máx:</label>
                    <input
                        type="number"
                        class="form-control form-control-sm"
                        placeholder="0.00"
                        [(ngModel)]="filtros.monto_max"
                        min="0"
                        step="0.01"
                    />
                </div>

                <!-- Botones de filtro -->
                <div class="col-lg-2 col-md-4 col-sm-12">
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary btn-sm flex-fill" (click)="aplicarFiltros()">
                            Buscar
                        </button>
                        <button class="btn btn-outline-secondary btn-sm flex-fill" (click)="limpiarFiltros()">
                            Limpiar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div *ngIf="cargando" class="card shadow-sm">
        <div class="card-body text-center py-5">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="text-muted">Cargando pedidos...</div>
        </div>
    </div>

    <!-- Error -->
    <div *ngIf="error && !cargando" class="card shadow-sm">
        <div class="card-body text-center py-5">
            <div class="alert alert-danger mb-3" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                {{ error }}
            </div>
            <button class="btn btn-secondary" (click)="cargarPedidos()">
                Reintentar
            </button>
        </div>
    </div>

    <!-- Tabla de pedidos -->
    <div *ngIf="!cargando && !error" class="card shadow-sm">
        <!-- Info de resultados -->
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <span class="text-muted small">
                Mostrando {{ pedidos.length }} de {{ totalPedidos }} pedidos
            </span>
            <div class="text-muted small fw-medium" *ngIf="paginacion">
                Página {{ paginacion.current_page }} de {{ paginacion.last_page }}
            </div>
        </div>

        <!-- Tabla -->
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="fw-semibold">ID</th>
                        <th class="fw-semibold">Cliente</th>
                        <th class="fw-semibold">Total</th>
                        <th class="fw-semibold text-center">Productos</th>
                        <th class="fw-semibold text-center">Estado</th>
                        <th class="fw-semibold text-center">Pago</th>
                        <th class="fw-semibold">Fecha</th>
                        <th class="fw-semibold text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let pedido of pedidos">
                        <!-- ID del pedido -->
                        <td>
                            <span class="pedido-id">PED-{{ pedido.id }}</span>
                        </td>

                        <!-- Cliente -->
                        <td>
                            <div>
                                <div class="fw-semibold text-dark small">{{ pedido.cliente.nombre }}</div>
                                <div class="text-muted" style="font-size: 0.75rem;">
                                    {{ pedido.cliente.dni }} • {{ pedido.cliente.email }}
                                </div>
                            </div>
                        </td>

                        <!-- Total -->
                        <td>
                            <span class="total-amount">{{ formatearMoneda(pedido.total) }}</span>
                        </td>

                        <!-- Cantidad de items -->
                        <td class="text-center">
                            <span class="badge bg-light text-dark">{{ pedido.cantidad_items }} items</span>
                        </td>

                        <!-- Estado -->
                        <td class="text-center">
                            <span 
                                class="badge estado-badge"
                                [class]="getEstadoClase(pedido.estado_pedido)"
                            >
                                {{ pedido.estado_pedido | titlecase }}
                            </span>

                            <div *ngIf="estaEditandoEstado(pedido.id)" class="spinner-border spinner-border-sm text-primary mt-1" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </td>

                        <!-- Estado del pago -->
                        <td class="text-center">
                            <span 
                                class="badge"
                                [class.bg-success]="pedido.tiene_pago_aprobado"
                                [class.bg-warning]="!pedido.tiene_pago_aprobado"
                                [class.text-dark]="!pedido.tiene_pago_aprobado"
                            >
                                {{ pedido.tiene_pago_aprobado ? 'Aprobado' : 'Pendiente' }}
                            </span>
                            <div *ngIf="pedido.metodos_pago.length > 0" class="mt-1">
                                <span *ngFor="let metodo of pedido.metodos_pago" class="badge bg-secondary me-1" style="font-size: 0.6rem;">
                                    {{ metodo }}
                                </span>
                            </div>
                        </td>

                        <!-- Fecha -->
                        <td>
                            <span class="text-muted small" style="font-family: monospace;">{{ formatearFecha(pedido.fecha_pedido) }}</span>
                        </td>

                        <!-- Acciones -->
                        <td class="text-center">
                        <div class="d-flex justify-content-center gap-1">
                            <!-- Ver Detalles -->
                            <button 
                            class="btn btn-outline-info btn-sm"
                            (click)="verDetallePedido(pedido.id)"
                            title="Ver detalles"
                            >
                            <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        </td>
                    </tr>

                    <!-- Mensaje cuando no hay pedidos -->
                    <tr *ngIf="pedidos.length === 0">
                        <td colspan="8" class="text-center py-5">
                            <div class="empty-state">
                                <div class="display-1 opacity-25">📦</div>
                                <h4 class="mt-3 mb-2">No hay pedidos</h4>
                                <p class="text-muted mb-3">No se encontraron pedidos con los filtros aplicados.</p>
                                <button class="btn btn-primary" (click)="limpiarFiltros()">
                                    Ver todos los pedidos
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Paginación -->
        <div *ngIf="paginacion && paginacion.last_page > 1" class="card-footer bg-light">
            <nav aria-label="Paginación de pedidos">
                <ul class="pagination justify-content-center mb-0">
                    <li class="page-item" [class.disabled]="paginacion.current_page === 1">
                        <button 
                            class="page-link"
                            [disabled]="paginacion.current_page === 1"
                            (click)="cambiarPagina(paginacion.current_page - 1)"
                        >
                            Anterior
                        </button>
                    </li>
                    
                    <li 
                        *ngFor="let pagina of getPaginasVisibles()"
                        class="page-item"
                        [class.active]="pagina === paginacion.current_page"
                        [class.disabled]="pagina === -1"
                    >
                        <button 
                            class="page-link"
                            [disabled]="pagina === -1"
                            (click)="pagina !== -1 && cambiarPagina(pagina)"
                        >
                            {{ pagina === -1 ? '...' : pagina }}
                        </button>
                    </li>
                    
                    <li class="page-item" [class.disabled]="paginacion.current_page === paginacion.last_page">
                        <button 
                            class="page-link"
                            [disabled]="paginacion.current_page === paginacion.last_page"
                            (click)="cambiarPagina(paginacion.current_page + 1)"
                        >
                            Siguiente
                        </button>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Modal de detalle del pedido -->
<div *ngIf="mostrarModal" class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.6);" (click)="cerrarModal()">
    <div class="modal-dialog modal-xl modal-dialog-scrollable" (click)="$event.stopPropagation()">
        <div class="modal-content">
            <!-- Header del modal -->
            <div class="modal-header bg-light">
                <h4 class="modal-title fw-semibold">
                    Detalles del Pedido {{ pedidoDetalle?.id ? 'PED-' + pedidoDetalle?.id : '' }}
                </h4>
                <button type="button" class="btn-close" (click)="cerrarModal()" aria-label="Close"></button>
            </div>

            <!-- Loading del modal -->
            <div *ngIf="cargandoDetalle" class="modal-body text-center py-5">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="text-muted">Cargando detalles del pedido...</div>
            </div>

            <!-- Error del modal -->
            <div *ngIf="errorDetalle && !cargandoDetalle" class="modal-body text-center py-5">
                <div class="alert alert-danger mb-3" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    {{ errorDetalle }}
                </div>
                <button class="btn btn-secondary" (click)="cargarDetallePedido(pedidoSeleccionado!)">
                    Reintentar
                </button>
            </div>

            <!-- Contenido del modal -->
            <div *ngIf="pedidoDetalle && !cargandoDetalle && !errorDetalle" class="modal-body">
                
                <!-- Información del cliente -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-user me-2"></i>
                            Información del Cliente
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <strong class="text-muted small d-block">NOMBRE:</strong>
                                <span>{{ pedidoDetalle.cliente.nombre }}</span>
                            </div>
                            <div class="col-md-6">
                                <strong class="text-muted small d-block">DNI:</strong>
                                <span>{{ pedidoDetalle.cliente.dni }}</span>
                            </div>
                            <div class="col-md-6">
                                <strong class="text-muted small d-block">EMAIL:</strong>
                                <span>{{ pedidoDetalle.cliente.email }}</span>
                            </div>
                            <div class="col-md-6">
                                <strong class="text-muted small d-block">TELÉFONO:</strong>
                                <span>{{ pedidoDetalle.cliente.telefono || 'No registrado' }}</span>
                            </div>
                            <div class="col-12">
                                <strong class="text-muted small d-block">DIRECCIÓN DE ENVÍO:</strong>
                                <span>{{ pedidoDetalle.direccion_envio }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Información del pedido -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-shopping-cart me-2"></i>
                            Resumen del Pedido
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <strong class="text-muted small d-block">ESTADO:</strong>
                                <span class="badge estado-badge" [class]="getEstadoClase(pedidoDetalle.estado_pedido)">
                                    {{ pedidoDetalle.estado_pedido | titlecase }}
                                </span>
                            </div>
                            <div class="col-md-3">
                                <strong class="text-muted small d-block">TOTAL:</strong>
                                <span class="total-amount">{{ formatearMoneda(pedidoDetalle.total) }}</span>
                            </div>
                            <div class="col-md-3">
                                <strong class="text-muted small d-block">FECHA DEL PEDIDO:</strong>
                                <span class="small" style="font-family: monospace;">{{ formatearFecha(pedidoDetalle.fecha_pedido) }}</span>
                            </div>
                            <div class="col-md-3">
                                <strong class="text-muted small d-block">ÚLTIMA ACTUALIZACIÓN:</strong>
                                <span class="small" style="font-family: monospace;">{{ formatearFecha(pedidoDetalle.ultima_actualizacion) }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Items del pedido -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-box me-2"></i>
                            Productos ({{ pedidoDetalle.items?.length }} items)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div *ngFor="let item of pedidoDetalle.items" class="col-12">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <div class="row align-items-center">
                                            <div class="col-auto">
                                                <img 
                                                    [src]="getImagenProducto(item.producto)" 
                                                    alt="{{ item.producto.nombre }}" 
                                                    (error)="handleImgError($event)"
                                                    class="rounded border"
                                                    style="width: 60px; height: 60px; object-fit: cover;"
                                                />
                                            </div>
                                            <div class="col">
                                                <h6 class="mb-1">{{ item.producto.nombre }}</h6>
                                                <small class="text-muted d-block mb-2">SKU: {{ item.producto.sku }}</small>
                                                <div class="row text-center">
                                                    <div class="col">
                                                        <small class="text-muted d-block">CANTIDAD</small>
                                                        <span class="badge bg-primary">{{ item.cantidad }}</span>
                                                    </div>
                                                    <div class="col">
                                                        <small class="text-muted d-block">PRECIO UNIT.</small>
                                                        <span class="small">{{ formatearMoneda(item.precio_venta) }}</span>
                                                    </div>
                                                    <div class="col">
                                                        <small class="text-muted d-block">SUBTOTAL</small>
                                                        <strong class="text-success">{{ formatearMoneda(item.subtotal) }}</strong>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Información de pagos -->
                <div class="card mb-4" *ngIf="pedidoDetalle.pagos && pedidoDetalle.pagos.length > 0">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-credit-card me-2"></i>
                            Información de Pagos
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div *ngFor="let pago of pedidoDetalle.pagos" class="col-md-6">
                                <div class="card border">
                                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                        <span class="fw-semibold">{{ pago.metodo_pago | titlecase }}</span>
                                        <span class="badge" [class]="getPagoEstadoClase(pago.estado_pago)">
                                            {{ getPagoEstadoTexto(pago.estado_pago) }}
                                        </span>
                                    </div>
                                    <div class="card-body small">
                                        <div class="mb-2">
                                            <strong class="text-muted small d-block">MONTO:</strong>
                                            <span>{{ formatearMoneda(pago.monto) }} {{ pago.moneda }}</span>
                                        </div>
                                        <div class="mb-2">
                                            <strong class="text-muted small d-block">FECHA:</strong>
                                            <span style="font-family: monospace;">{{ formatearFecha(pago.fecha_pago) }}</span>
                                        </div>
                                        <div *ngIf="pago.culqi_charge_id" class="mb-0">
                                            <strong class="text-muted small d-block">ID TRANSACCIÓN:</strong>
                                            <code class="small">{{ pago.culqi_charge_id }}</code>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Footer del modal -->
            <div *ngIf="!cargandoDetalle && !errorDetalle" class="modal-footer bg-light">
                <!-- Cambio de estado -->
                <div class="d-flex align-items-center gap-3 me-auto" *ngIf="pedidoDetalle && puedeEditarEstado(pedidoDetalle)">
                    <label class="form-label mb-0 fw-medium">Cambiar estado:</label>
                    <select 
                        class="form-select form-select-sm"
                        style="width: auto;"
                        [(ngModel)]="nuevoEstado"
                        [disabled]="cargandoEstado"
                    >
                        <option [value]="pedidoDetalle.estado_pedido">{{ getEstadoTexto(pedidoDetalle.estado_pedido) }} (Actual)</option>
                        <option *ngFor="let estado of getEstadosDisponibles(pedidoDetalle.estado_pedido)" [value]="estado.valor">
                            {{ estado.etiqueta }}
                        </option>
                    </select>
                    <button 
                        class="btn btn-primary btn-sm"
                        [disabled]="nuevoEstado === pedidoDetalle.estado_pedido || cargandoEstado"
                        (click)="actualizarEstadoPedido(pedidoDetalle.id, nuevoEstado)"
                    >
                        <span *ngIf="cargandoEstado">
                            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                            Actualizando...
                        </span>
                        <span *ngIf="!cargandoEstado">Actualizar Estado</span>
                    </button>
                </div>

                <button type="button" class="btn btn-secondary" (click)="cerrarModal()">
                    Cerrar
                </button>
            </div>

        </div>
    </div>
</div>