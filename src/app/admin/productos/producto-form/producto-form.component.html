<!-- Modal -->
<div *ngIf="mostrar" class="modal fade show d-block" style="background: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-xl modal-dialog-scrollable" (click)="$event.stopPropagation()">
    <div class="modal-content">
      
      <!-- Header -->
      <div class="modal-header">
        <h5 class="modal-title">{{ getTitulo() }}</h5>
        <button type="button" class="btn-close" (click)="cerrarModal()"></button>
      </div>
      
      <!-- Body -->
      <div class="modal-body">
        
        <!-- Mensaje de respuesta -->
        <div *ngIf="mensaje" class="alert d-flex align-items-center mb-4" 
             [class]="'alert-' + (tipoMensaje === 'success' ? 'success' : 'danger')" role="alert">
          <span class="me-2">{{ tipoMensaje === 'success' ? '‚úì' : '‚ö†Ô∏è' }}</span>
          {{ mensaje }}
        </div>
        
        <!-- Formulario -->
        <form (ngSubmit)="guardar()" #productoForm="ngForm">
          
          <!-- Nombre del producto -->
          <div class="mb-3">
            <label class="form-label fw-semibold">
              <i class="fas fa-box text-primary me-1"></i>
              Nombre del producto 
              <span class="text-danger">*</span>
            </label>
            <input type="text" class="form-control form-control-lg border-2" 
                  [(ngModel)]="formulario.nombre" name="nombre"
                  [class.is-invalid]="errores.nombre"
                  placeholder="Ingresa el nombre del producto" 
                  maxlength="150" required>
            <div *ngIf="errores.nombre" class="invalid-feedback">
              <i class="fas fa-exclamation-circle me-1"></i>
              {{ errores.nombre }}
            </div>
          </div>

          <!-- Slug del producto -->
          <div class="mb-3">
            <label class="form-label fw-semibold">
              <i class="fas fa-link text-primary me-1"></i>
              Slug del producto 
              <span class="text-danger">*</span>
            </label>
            <div class="input-group">
              <input type="text" class="form-control border-2"
                    [(ngModel)]="formulario.producto_slug" name="producto_slug"
                    [class.is-invalid]="errores.producto_slug"
                    placeholder="slug-del-producto"
                    maxlength="200" required>
              <button class="btn btn-outline-secondary" type="button" 
                      (click)="generarSlug()"
                      title="Generar slug autom√°tico desde el nombre">
                <i class="fas fa-sync"></i>
              </button>
            </div>
            <div *ngIf="errores.producto_slug" class="invalid-feedback d-block">
              <i class="fas fa-exclamation-circle me-1"></i>
              {{ errores.producto_slug }}
            </div>
            <small class="form-text text-muted">
              <i class="fas fa-info-circle me-1"></i>
              URL amigable para el producto. Se genera autom√°ticamente desde el nombre.
            </small>
          </div>

          <!-- SKU -->
          <div class="mb-3">
            <label class="form-label fw-semibold">
              <i class="fas fa-barcode text-primary me-1"></i>
              SKU (C√≥digo)
            </label>
            <input type="text" class="form-control"
                  [(ngModel)]="formulario.sku" name="sku"
                  [class.is-invalid]="errores.sku"
                  placeholder="C√≥digo √∫nico del producto" 
                  maxlength="50">
            <div *ngIf="errores.sku" class="invalid-feedback">
              {{ errores.sku }}
            </div>
            <small class="form-text text-muted">
              C√≥digo √∫nico de identificaci√≥n del producto (opcional)
            </small>
          </div>
          
          <!-- Categor√≠a y Tienda -->
          <div class="row g-3 mb-3">
            <!-- Categor√≠a Padre -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Categor√≠a Principal</label>
              <select class="form-select" 
                      [(ngModel)]="categoriaPadreSeleccionada" 
                      name="categoria_padre"
                      (ngModelChange)="onCategoriaPadreChange($event)"
                      [class.is-invalid]="errores.categoria_padre_id">
                <option [ngValue]="null" disabled selected>-- Selecciona una categor√≠a --</option>
                <option *ngFor="let categoria of categoriasPadre" [ngValue]="categoria.id">
                  {{ categoria.nombre }}
                </option>
              </select>
              <div *ngIf="cargandoCategoriasPadre" class="form-text">Cargando categor√≠as...</div>
              <div *ngIf="errores.categoria_padre_id" class="invalid-feedback">
                {{ errores.categoria_padre_id }}
              </div>
            </div>

            <!-- Subcategor√≠a (aparece cuando se selecciona una categor√≠a padre) -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Subcategor√≠a</label>
              <select class="form-select" 
                      [(ngModel)]="formulario.categoria_id" 
                      name="categoria_id"
                      [class.is-invalid]="errores.categoria_id"
                      [disabled]="!categoriaPadreSeleccionada || cargandoSubcategorias">
                <option [ngValue]="null" disabled selected>
                  {{ !categoriaPadreSeleccionada 
                    ? '-- Primero selecciona una categor√≠a --' 
                    : (subcategorias.length === 0 
                        ? '-- No hay subcategor√≠as --' 
                        : '-- Selecciona una subcategor√≠a --') }}
                </option>
                <option *ngFor="let sub of subcategorias" [ngValue]="sub.id">
                  {{ sub.nombre }}
                </option>
              </select>
              <div *ngIf="cargandoSubcategorias" class="form-text">
                <span class="spinner-border spinner-border-sm me-1"></span>
                Cargando subcategor√≠as...
              </div>
              <div *ngIf="errores.categoria_id" class="invalid-feedback">
                {{ errores.categoria_id }}
              </div>
            </div>
          </div>

            <!-- Tienda (mantener en fila separada o ajustar seg√∫n prefieras) -->
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label class="form-label fw-semibold">Tienda</label>
                <select class="form-select" [(ngModel)]="formulario.tienda_id" name="tienda_id"
                        [class.is-invalid]="errores.tienda_id">
                  <option value="" disabled selected>-- Selecciona una tienda --</option>
                  <option *ngFor="let tienda of tiendas" [value]="tienda.id">
                    {{ tienda.nombre }}
                  </option>
                </select>
                <div *ngIf="cargandoTiendas" class="form-text">Cargando tiendas...</div>
                <div *ngIf="errores.tienda_id" class="invalid-feedback">
                  {{ errores.tienda_id }}
                </div>
              </div>
            </div>
          
          <!-- Precio, Descuento y Stock -->
          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <label class="form-label fw-semibold">Precio (PEN) *</label>
              <div class="input-group">
                <span class="input-group-text">S/</span>
                <input type="number" class="form-control"
                       [(ngModel)]="formulario.precio" name="precio"
                       [class.is-invalid]="errores.precio"
                       placeholder="0.00" step="0.01" min="0" required>
              </div>
              <div *ngIf="errores.precio" class="invalid-feedback">
                {{ errores.precio }}
              </div>
            </div>
            <div class="col-md-4">
              <label class="form-label fw-semibold">Descuento (%)</label>
              <input type="number" class="form-control"
                     [(ngModel)]="formulario.descuento" name="descuento"
                     [class.is-invalid]="errores.descuento"
                     placeholder="0" min="0" max="100" step="0.01"
                     (ngModelChange)="formulario.descuento = $event === null || $event === '' ? 0 : $event">
              <div class="form-text">Porcentaje de descuento (0-100)</div>
              <div *ngIf="errores.descuento" class="invalid-feedback">
                {{ errores.descuento }}
              </div>
            </div>
            <div class="col-md-4">
              <label class="form-label fw-semibold">Stock *</label>
              <input type="number" class="form-control"
                     [(ngModel)]="formulario.stock" name="stock"
                     [class.is-invalid]="errores.stock"
                     placeholder="0" min="0" required>
              <div *ngIf="errores.stock" class="invalid-feedback">
                {{ errores.stock }}
              </div>
            </div>
          </div>
          
          <!-- Estado -->
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label class="form-label fw-semibold">Estado</label>
              <select class="form-select" [(ngModel)]="formulario.estado" name="estado">
                <option value="activo">Activo</option>
                <option value="inactivo">Inactivo</option>
              </select>
            </div>
          </div>

          <!-- Pack-->
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="es_pack" 
                      [(ngModel)]="formulario.es_pack" name="es_pack">
                <label class="form-check-label fw-semibold" for="es_pack">
                  ¬øEs un pack?
                </label>
              </div>
              <div class="form-text">Marcar si este producto es un pack o conjunto de productos</div>
            </div>
          </div>
          <!-- Etiqueta -->
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label class="form-label fw-semibold">Etiqueta</label>
              
              <!-- Mensajes de estado -->
              <div *ngIf="cargandoEtiquetas" class="alert alert-info py-2 mb-2">
                <small>‚è≥ Cargando etiquetas activas...</small>
              </div>
              
              <div *ngIf="!cargandoEtiquetas && etiquetasActivas.length === 0" class="alert alert-warning py-2 mb-2">
                <small>‚ö†Ô∏è No hay etiquetas activas disponibles</small>
              </div>
              
              <select class="form-select" [(ngModel)]="formulario.etiqueta_id" name="etiqueta_id"
                      [class.is-invalid]="errores.etiqueta_id"
                      [disabled]="cargandoEtiquetas">
                <option [ngValue]="null" selected>-- Sin etiqueta --</option>
                <option *ngFor="let etiqueta of etiquetasActivas" [value]="etiqueta.id">
                  {{ etiqueta.nombre }}
                </option>
              </select>
              
              <div *ngIf="errores.etiqueta_id" class="invalid-feedback">
                {{ errores.etiqueta_id }}
              </div>
              
              <div class="form-text" *ngIf="etiquetasActivas.length > 0">
                {{ etiquetasActivas.length }} etiquetas activas disponibles
              </div>
            </div>
          </div>
          
          <!-- Descripci√≥n -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Descripci√≥n *</label>
            <textarea class="form-control" rows="4"
                      [(ngModel)]="formulario.descripcion" name="descripcion"
                      [class.is-invalid]="errores.descripcion"
                      placeholder="Describe las caracter√≠sticas del producto" required></textarea>
            <div *ngIf="errores.descripcion" class="invalid-feedback">
              {{ errores.descripcion }}
            </div>
          </div>
          
          <!-- Detalle -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Ingredientes</label>
            <textarea class="form-control" rows="3"
                      [(ngModel)]="formulario.ingredientes" name="ingredientes"
                      [class.is-invalid]="errores.ingredientes"
                      placeholder="Ingredientes del producto"></textarea>
            <div *ngIf="errores.ingredientes" class="invalid-feedback">
              {{ errores.ingredientes }}
            </div>
          </div>

          <!-- Vida util -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Vida √∫til</label>
            <textarea class="form-control" rows="3"
                      [(ngModel)]="formulario.vida_util" name="vida_util"
                      [class.is-invalid]="errores.vida_util"
                      placeholder="Vida util del producto"></textarea>
            <div *ngIf="errores.vida_util" class="invalid-feedback">
              {{ errores.vida_util }}
            </div>
          </div>
          
          <!-- Beneficios -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Beneficios</label>
            <textarea class="form-control" rows="3"
                      [(ngModel)]="formulario.beneficios" name="beneficios"
                      [class.is-invalid]="errores.beneficios"
                      placeholder="Enumera los beneficios del producto"></textarea>
            <div *ngIf="errores.beneficios" class="invalid-feedback">
              {{ errores.beneficios }}
            </div>
          </div>
          
          <!-- Modo de uso -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Modo de uso</label>
            <textarea class="form-control" rows="3"
                      [(ngModel)]="formulario.modo_uso" name="modo_uso"
                      [class.is-invalid]="errores.modo_uso"
                      placeholder="Instrucciones de uso del producto"></textarea>
            <div *ngIf="errores.modo_uso" class="invalid-feedback">
              {{ errores.modo_uso }}
            </div>
          </div>

          <div class="card border-primary mb-4">
          <div class="card-header bg-primary text-white">
            <h6 class="mb-0">Preguntas Frecuentes (FAQ)</h6>
          </div>
          <div class="card-body">
    
              <!-- ¬øQui√©nes pueden tomar? -->
              <div class="mb-3">
                <label class="form-label fw-semibold">¬øQui√©nes pueden tomar este producto?</label>
                <textarea class="form-control" rows="3"
                          [(ngModel)]="formulario.faq_quienes_toman" name="faq_quienes_toman"
                          [class.is-invalid]="errores.faq_quienes_toman"
                          placeholder="Ej: Personas mayores de 18 a√±os, no recomendado para embarazadas..."></textarea>
                <div *ngIf="errores.faq_quienes_toman" class="invalid-feedback">
                  {{ errores.faq_quienes_toman }}
                </div>
              </div>
              
              <!-- ¬øPor qu√© elegir? -->
              <div class="mb-3">
                <label class="form-label fw-semibold">¬øPor qu√© elegir este producto?</label>
                <textarea class="form-control" rows="3"
                          [(ngModel)]="formulario.faq_por_que_elegir" name="faq_por_que_elegir"
                          [class.is-invalid]="errores.faq_por_que_elegir"
                          placeholder="Ventajas y diferenciadores del producto..."></textarea>
                <div *ngIf="errores.faq_por_que_elegir" class="invalid-feedback">
                  {{ errores.faq_por_que_elegir }}
                </div>
              </div>
              
              <!-- Tiempo de uso -->
              <div class="mb-3">
                <label class="form-label fw-semibold">¬øCu√°nto tiempo se debe usar?</label>
                <textarea class="form-control" rows="3"
                          [(ngModel)]="formulario.faq_tiempo_uso" name="faq_tiempo_uso"
                          [class.is-invalid]="errores.faq_tiempo_uso"
                          placeholder="Duraci√≥n recomendada del tratamiento..."></textarea>
                <div *ngIf="errores.faq_tiempo_uso" class="invalid-feedback">
                  {{ errores.faq_tiempo_uso }}
                </div>
              </div>
              
              <!-- Efectos secundarios -->
              <div class="mb-3">
                <label class="form-label fw-semibold">¬øTiene efectos secundarios?</label>
                <textarea class="form-control" rows="3"
                          [(ngModel)]="formulario.faq_efectos_secundarios" name="faq_efectos_secundarios"
                          [class.is-invalid]="errores.faq_efectos_secundarios"
                          placeholder="Posibles efectos secundarios o contraindicaciones..."></textarea>
                <div *ngIf="errores.faq_efectos_secundarios" class="invalid-feedback">
                  {{ errores.faq_efectos_secundarios }}
                </div>
              </div>
              
              <!-- Consumo de alcohol -->
              <div class="mb-3">
                <label class="form-label fw-semibold">¬øSe puede consumir alcohol mientras se usa?</label>
                <textarea class="form-control" rows="3"
                          [(ngModel)]="formulario.faq_consumo_alcohol" name="faq_consumo_alcohol"
                          [class.is-invalid]="errores.faq_consumo_alcohol"
                          placeholder="Interacciones con alcohol..."></textarea>
                <div *ngIf="errores.faq_consumo_alcohol" class="invalid-feedback">
                  {{ errores.faq_consumo_alcohol }}
                </div>
              </div>
            </div>
          </div>
          
          <!-- Im√°genes -->
          <div class="mb-3">
            <label class="form-label fw-semibold">
              Im√°genes del producto ({{ getTotalImagenesActivas() }}/14)
            </label>
            
            <!-- Input de archivos -->
            <input type="file" class="form-control mb-3"
                   [class.is-invalid]="errores.imagenes"
                   (change)="onArchivosSeleccionados($event)"
                   accept="image/*" multiple>
            
            <!-- Im√°genes existentes -->
            <div *ngIf="imagenesExistentes.length > 0" class="mb-4">
              <h6 class="text-muted border-bottom pb-2 mb-3">Im√°genes actuales</h6>
              <div class="imagen-grid">
                <div *ngFor="let imagen of imagenesExistentes; let i = index" 
                     class="imagen-item"
                     [class.opacity-50]="estaMarcadaParaEliminar(imagen.id)"
                     [class.principal]="imagen.es_principal && !estaMarcadaParaEliminar(imagen.id)">
                  
                  <img [src]="imagen.imagen_url" [alt]="imagen.alt_text" class="imagen-preview">
                  
                  <!-- Badge principal -->
                  <span *ngIf="imagen.es_principal && !estaMarcadaParaEliminar(imagen.id)" 
                        class="badge bg-warning position-absolute badge-principal">Principal</span>
                  
                  <!-- Overlay eliminada -->
                  <div *ngIf="estaMarcadaParaEliminar(imagen.id)" class="overlay-eliminada">
                    <span>Ser√° eliminada</span>
                  </div>
                  
                  <!-- Botones de acci√≥n -->
                  <div class="imagen-actions">
                    <button *ngIf="!imagen.es_principal && !estaMarcadaParaEliminar(imagen.id) && !enviando"
                            type="button" class="btn btn-warning btn-sm btn-action"
                            (click)="establecerImagenExistentePrincipal(imagen.id)"
                            title="Establecer como principal" [disabled]="enviando">‚≠ê</button>
                    <button *ngIf="!estaMarcadaParaEliminar(imagen.id)"
                            type="button" class="btn btn-danger btn-sm btn-action"
                            (click)="marcarEliminarImagenExistente(imagen.id)"
                            title="Eliminar imagen" [disabled]="enviando">üóëÔ∏è</button>
                    <button *ngIf="estaMarcadaParaEliminar(imagen.id)"
                            type="button" class="btn btn-success btn-sm btn-action"
                            (click)="cancelarEliminarImagenExistente(imagen.id)"
                            title="Cancelar eliminaci√≥n" [disabled]="enviando">‚Ü∂</button>
                  </div>
                  
                  <!-- Info -->
                  <div class="position-absolute bottom-0 start-0 end-0 bg-light p-1 border-top">
                    <small class="text-muted d-block text-truncate">
                      Imagen {{ i + 1 }}
                      <span *ngIf="imagen.es_principal && !estaMarcadaParaEliminar(imagen.id)" class="text-warning"> (Principal)</span>
                    </small>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Nuevas im√°genes -->
            <div *ngIf="imagenesSeleccionadas.length > 0" class="mb-4">
              <h6 class="text-muted border-bottom pb-2 mb-3">Nuevas im√°genes</h6>
              <div class="imagen-grid">
                <div *ngFor="let preview of previsualizacionImagenes; let i = index" 
                     class="imagen-item"
                     [class.principal]="imagenPrincipalIndex === i && !tieneImagenPrincipalExistente()">
                  
                  <img [src]="preview" [alt]="'Nueva imagen ' + (i + 1)" class="imagen-preview">
                  
                  <!-- Badge principal -->
                  <span *ngIf="imagenPrincipalIndex === i && !tieneImagenPrincipalExistente()" 
                        class="badge bg-warning position-absolute badge-principal">Principal</span>
                  
                  <!-- Botones de acci√≥n -->
                  <div class="imagen-actions">
                    <button *ngIf="!tieneImagenPrincipalExistente() && imagenPrincipalIndex !== i"
                            type="button" class="btn btn-warning btn-sm btn-action"
                            (click)="establecerImagenPrincipal(i)"
                            title="Establecer como principal">‚≠ê</button>
                    <button type="button" class="btn btn-danger btn-sm btn-action"
                            (click)="eliminarImagenSeleccionada(i)"
                            title="Quitar imagen">üóëÔ∏è</button>
                  </div>
                  
                  <!-- Info -->
                  <div class="position-absolute bottom-0 start-0 end-0 bg-light p-1 border-top">
                    <small class="text-muted d-block text-truncate">{{ imagenesSeleccionadas[i].name }}</small>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Ayuda -->
            <div class="form-text">
              Formatos permitidos: JPG, PNG, WEBP. Tama√±o m√°ximo: 5MB por imagen. M√°ximo 14 im√°genes.
            </div>
            
            <div *ngIf="errores.imagenes" class="invalid-feedback d-block">
              {{ errores.imagenes }}
            </div>
          </div>
          
        </form>
        
      </div>
      
      <!-- Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" 
                (click)="cerrarModal()" [disabled]="enviando">
          Cancelar
        </button>
        <button type="button" class="btn btn-primary" 
                (click)="guardar()" [disabled]="enviando || !productoForm.valid">
          <span *ngIf="enviando" class="spinner-border spinner-border-sm me-2" role="status"></span>
          {{ getTextoBotonGuardar() }}
        </button>
      </div>
      
    </div>
  </div>
</div>