<div class="categorias-container">
    <!-- Header -->
    <div class="categorias-header">
        <h1 class="titulo">Gesti√≥n de Categor√≠as</h1>
        <button class="btn btn-primary" (click)="mostrarFormularioCrear()">
        <span class="btn-icon">+</span>
        Nueva Categor√≠a
        </button>
    </div>

    <!-- Filtros -->
    <div class="filtros-section">
        <div class="filtros-row">
        <!-- B√∫squeda -->
        <div class="filtro-grupo">
            <label class="filtro-label">Buscar:</label>
            <input
            type="text"
            class="filtro-input"
            placeholder="Buscar por nombre..."
            [(ngModel)]="filtros.buscar"
            (keyup.enter)="aplicarFiltros()"
            />
        </div>

        <!-- Estado -->
        <div class="filtro-grupo">
            <label class="filtro-label">Estado:</label>
            <select class="filtro-select" [(ngModel)]="filtros.estado">
            <option value="todos">Todos</option>
            <option value="activo">Activo</option>
            <option value="inactivo">Inactivo</option>
            </select>
        </div>

        <!-- Botones de filtro -->
        <div class="filtro-acciones">
            <button class="btn btn-secondary" (click)="aplicarFiltros()">
            Buscar
            </button>
            <button class="btn btn-outline" (click)="limpiarFiltros()">
            Limpiar
            </button>
        </div>
        </div>
    </div>

    <!-- Loading -->
    <div *ngIf="cargando" class="loading-container">
        <div class="loading-spinner"></div>
        <span>Cargando categor√≠as...</span>
    </div>

    <!-- Error -->
    <div *ngIf="error && !cargando" class="error-container">
        <div class="error-message">
        <span class="error-icon">‚ö†Ô∏è</span>
        {{ error }}
        </div>
        <button class="btn btn-secondary" (click)="cargarCategorias()">
        Reintentar
        </button>
    </div>

    <!-- Tabla de categor√≠as -->
    <div *ngIf="!cargando && !error" class="tabla-container">
        <!-- Info de resultados -->
        <div class="resultados-info">
        <span>
            Mostrando {{ categorias.length }} categor√≠as
        </span>
        </div>

        <!-- Tabla -->
        <div class="tabla-wrapper">
        <table class="categorias-tabla">
            <thead>
            <tr>
                <th>Imagen</th>
                <th>Nombre</th>
                <th>Estado</th>
                <th>Fecha de Creaci√≥n</th>
                <th>Acciones</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let categoria of categorias" class="categoria-row">
              <!-- Imagen -->
                <td class="imagen-cell">
                  <div class="imagen-container">
                    <img 
                      *ngIf="categoria.imagen_url" 
                      [src]="categoria.imagen_url" 
                      [alt]="categoria.nombre"
                      class="categoria-imagen"
                      onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"
                    />
                    <div 
                      *ngIf="!categoria.imagen_url" 
                      class="imagen-placeholder"
                    >
                      <i class="fas fa-image"></i>
                    </div>
                  </div>
                </td>
                <!-- Nombre -->
                <td class="nombre-cell">
                <div class="categoria-info">
                    <span class="categoria-nombre">{{ categoria.nombre }}</span>
                </div>
                </td>

                <!-- Productos count -->
<!--                 <td class="productos-cell">
                <span class="productos-count">
                    {{ categoria.productos_count || 0 }} productos
                </span>
                </td> -->

                <!-- Estado -->
                <td class="estado-cell">
                <span 
                    class="estado-badge"
                    [class]="getEstadoClase(categoria.estado)"
                >
                    {{ categoria.estado }}
                </span>
                </td>

                <!-- Fecha de creaci√≥n -->
                <td class="fecha-cell">
                <span class="fecha-text">
                    {{ categoria.created_at | date:'dd/MM/yyyy HH:mm' }}
                </span>
                </td>

                <!-- Acciones -->
                <td class="acciones-cell">
                <div class="acciones-buttons">

                    <!-- Editar -->
                    <button class="btn-accion btn-editar" title="Editar" (click)="mostrarFormularioEditar(categoria)">
                    <i class="fas fa-edit"></i>
                    </button>

                    <!-- Desactivar -->
                    <button 
                    *ngIf="categoria.estado === 'activo'"
                    class="btn-accion btn-desactivar" 
                    title="Desactivar"
                    (click)="confirmarEliminar(categoria)"
                    >
                    <i class="fas fa-ban"></i>
                    </button>

                    <!-- Activar -->
                    <button 
                    *ngIf="categoria.estado === 'inactivo'"
                    class="btn-accion btn-activar" 
                    title="Activar"
                    (click)="confirmarActivar(categoria)"
                    >
                    <i class="fas fa-check"></i>
                    </button>

                </div>
                </td>

            </tr>

            <!-- Mensaje cuando no hay categor√≠as -->
            <tr *ngIf="categorias.length === 0" class="empty-row">
                <td colspan="5" class="empty-cell">
                <div class="empty-state">
                    <div class="empty-icon">üè∑Ô∏è</div>
                    <h3>No hay categor√≠as</h3>
                    <p>No se encontraron categor√≠as con los filtros aplicados.</p>
                    <button class="btn btn-primary" (click)="limpiarFiltros()">
                    Ver todas las categor√≠as
                    </button>
                </div>
                </td>
            </tr>
            </tbody>
        </table>
        </div>
    </div>
</div>

<!-- Modal de formulario -->
<div *ngIf="mostrarFormulario" class="modal-overlay" (click)="cerrarFormulario()">
  <!-- Modal Container -->
  <div class="modal-container" (click)="$event.stopPropagation()">
    
    <!-- Header -->
    <div class="modal-header">
      <h2 class="modal-titulo">{{ getTitulo() }}</h2>
      <button class="btn-cerrar" (click)="cerrarFormulario()" type="button">
        ‚úï
      </button>
    </div>

    <!-- Content -->
    <div class="modal-content">
      
      <!-- Mensaje de respuesta -->
      <div *ngIf="mensaje" class="mensaje" [class]="'mensaje-' + tipoMensaje">
        <span class="mensaje-icono">
          {{ tipoMensaje === 'success' ? '‚úì' : '‚ö†Ô∏è' }}
        </span>
        {{ mensaje }}
      </div>

      <!-- Formulario -->
      <form class="categoria-form" (ngSubmit)="guardar()" #categoriaForm="ngForm">
        
        <!-- Nombre -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="nombre">
              Nombre de la categor√≠a *
            </label>
            <input
              type="text"
              id="nombre"
              class="form-input"
              [(ngModel)]="formulario.nombre"
              name="nombre"
              placeholder="Ingresa el nombre de la categor√≠a"
              [class.error]="errores.nombre"
              required
              maxlength="150"
            />
            <div *ngIf="errores.nombre" class="error-message">
              {{ errores.nombre }}
            </div>
          </div>
        </div>

        <!-- Estado -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="estado">
              Estado
            </label>
            <select
              id="estado"
              class="form-select"
              [(ngModel)]="formulario.estado"
              name="estado"
            >
              <option value="activo">Activo</option>
              <option value="inactivo">Inactivo</option>
            </select>
          </div>
        </div>
        <!-- Imagen -->
<div class="form-row">
  <div class="form-group">
    <label class="form-label" for="imagen">
      Imagen de la categor√≠a
    </label>
    
    <!-- Preview de imagen actual o nueva -->
    <div *ngIf="tieneImagenParaMostrar()" class="imagen-preview">
      <img 
        [src]="previewImagen" 
        alt="Preview"
        class="preview-img"
      />
      <div class="imagen-acciones">
        <button 
          type="button" 
          class="btn-imagen-accion btn-eliminar-imagen" 
          (click)="eliminarImagen()"
          title="Eliminar imagen"
        >
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>

      <!-- Input de archivo -->
      <div class="file-input-container">
        <input
          type="file"
          id="imagen"
          class="file-input"
          accept="image/jpeg,image/jpg,image/png,image/webp"
          (change)="onImagenSeleccionada($event)"
          #fileInput
        />
        <label for="imagen" class="file-label">
          <i class="fas fa-upload"></i>
          <span *ngIf="!tieneImagenParaMostrar()">Seleccionar imagen</span>
          <span *ngIf="tieneImagenParaMostrar()">Cambiar imagen</span>
        </label>
      </div>

      <div *ngIf="errores.imagen" class="error-message">
        {{ errores.imagen }}
      </div>
      
      <div class="file-help">
        Formatos permitidos: JPG, PNG, WebP. Tama√±o m√°ximo: 2MB
      </div>
    </div>
  </div>

      </form>
    </div>

    <!-- Footer -->
    <div class="modal-footer">
      <button 
        type="button" 
        class="btn btn-secondary" 
        (click)="cerrarFormulario()"
        [disabled]="enviando"
      >
        Cancelar
      </button>
      <button 
        type="button" 
        class="btn btn-primary" 
        (click)="guardar()"
        [disabled]="enviando || !categoriaForm.valid"
      >
        <span *ngIf="enviando" class="btn-loading">
          <div class="loading-spinner-small"></div>
        </span>
        {{ getTextoBotonGuardar() }}
      </button>
    </div>

  </div>
</div>

<!-- Modal de confirmaci√≥n -->
<div *ngIf="mostrarConfirmacion" class="modal-overlay" (click)="cerrarConfirmacion()">
  <div class="modal-container confirmacion-modal" (click)="$event.stopPropagation()">
    
    <!-- Header -->
    <div class="modal-header">
      <h2 class="modal-titulo">Confirmar acci√≥n</h2>
      <button class="btn-cerrar" (click)="cerrarConfirmacion()" type="button">
        ‚úï
      </button>
    </div>

    <!-- Content -->
    <div class="modal-content">
      <div class="confirmacion-content">
        <div class="confirmacion-icon">
          <span *ngIf="accionConfirmacion === 'eliminar'" class="icon-warning">‚ö†Ô∏è</span>
          <span *ngIf="accionConfirmacion === 'activar'" class="icon-question">‚ùì</span>
        </div>
        <p class="confirmacion-mensaje">
          {{ mensajeConfirmacion }}
        </p>
      </div>
    </div>

    <!-- Footer -->
    <div class="modal-footer">
      <button 
        type="button" 
        class="btn btn-secondary" 
        (click)="cerrarConfirmacion()"
        [disabled]="procesandoAccion"
      >
        Cancelar
      </button>
      <button 
        type="button" 
        class="btn"
        [class.btn-danger]="accionConfirmacion === 'eliminar'"
        [class.btn-success]="accionConfirmacion === 'activar'"
        (click)="ejecutarAccion()"
        [disabled]="procesandoAccion"
      >
        <span *ngIf="procesandoAccion" class="btn-loading">
          <div class="loading-spinner-small"></div>
        </span>
        <span *ngIf="accionConfirmacion === 'eliminar'">
          {{ procesandoAccion ? 'Desactivando...' : 'Desactivar' }}
        </span>
        <span *ngIf="accionConfirmacion === 'activar'">
          {{ procesandoAccion ? 'Activando...' : 'Activar' }}
        </span>
      </button>
    </div>

  </div>
</div>