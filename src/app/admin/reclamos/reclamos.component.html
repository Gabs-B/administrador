<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2 fw-bold">Gesti√≥n de Reclamos y Quejas</h1>
        </div>
    </div>

    <!-- Estad√≠sticas -->
    <div class="row mb-4" *ngIf="estadisticas">
        <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
            <div class="card border-primary border-start border-4 h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div>
                            <div class="fs-2 fw-bold text-dark">{{ estadisticas.total }}</div>
                            <div class="small text-muted">Total</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
            <div class="card border-warning border-start border-4 h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div>
                            <div class="fs-2 fw-bold text-dark">{{ estadisticas.pendientes }}</div>
                            <div class="small text-muted">Pendientes</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
            <div class="card border-info border-start border-4 h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div>
                            <div class="fs-2 fw-bold text-dark">{{ estadisticas.en_proceso }}</div>
                            <div class="small text-muted">En Proceso</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
            <div class="card border-success border-start border-4 h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div>
                            <div class="fs-2 fw-bold text-dark">{{ estadisticas.resueltas }}</div>
                            <div class="small text-muted">Resueltas</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
            <div class="card border-danger border-start border-4 h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div>
                            <div class="fs-2 fw-bold text-dark">{{ estadisticas.reclamos }}</div>
                            <div class="small text-muted">Reclamos</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
            <div class="card border-secondary border-start border-4 h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div>
                            <div class="fs-2 fw-bold text-dark">{{ estadisticas.quejas }}</div>
                            <div class="small text-muted">Quejas</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <!-- B√∫squeda -->
                <div class="col-md-2">
                    <label class="form-label fw-semibold">Buscar:</label>
                    <input
                        type="text"
                        class="form-control"
                        placeholder="N√∫mero, DNI, nombre o email..."
                        [(ngModel)]="filtros.buscar"
                        (keyup.enter)="aplicarFiltros()"
                    />
                </div>

                <!-- Estado -->
                <div class="col-md-2">
                    <label class="form-label fw-semibold">Estado:</label>
                    <select class="form-select" [(ngModel)]="filtros.estado">
                        <option *ngFor="let opcion of estadosOptions" [value]="opcion.value">
                            {{ opcion.label }}
                        </option>
                    </select>
                </div>

                <!-- Tipo -->
                <div class="col-md-2">
                    <label class="form-label fw-semibold">Tipo:</label>
                    <select class="form-select" [(ngModel)]="filtros.tipo_reclamo">
                        <option *ngFor="let opcion of tiposReclamoOptions" [value]="opcion.value">
                            {{ opcion.label }}
                        </option>
                    </select>
                </div>

                <!-- Fecha desde -->
                <div class="col-md-2">
                    <label class="form-label fw-semibold">Desde:</label>
                    <input
                        type="date"
                        class="form-control"
                        [(ngModel)]="filtros.fecha_desde"
                    />
                </div>

                <!-- Fecha hasta -->
                <div class="col-md-2">
                    <label class="form-label fw-semibold">Hasta:</label>
                    <input
                        type="date"
                        class="form-control"
                        [(ngModel)]="filtros.fecha_hasta"
                    />
                </div>

                <!-- Botones -->
                <div class="col-md-1 d-flex align-items-end">
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" (click)="aplicarFiltros()" [disabled]="cargando">
                            <span *ngIf="!cargando">üîç</span>
                            <span *ngIf="cargando" class="spinner-border spinner-border-sm me-1"></span>
                            {{ cargando ? 'Cargando...' : 'Buscar' }}
                        </button>
                        <button class="btn btn-outline-secondary" (click)="limpiarFiltros()" [disabled]="cargando">
                            üóëÔ∏è Limpiar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div *ngIf="cargando" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3">Cargando reclamos...</p>
    </div>

    <!-- Error -->
    <div *ngIf="error && !cargando" class="alert alert-danger" role="alert">
        <div class="d-flex align-items-center">
            <i class="fas fa-exclamation-triangle me-2"></i>
            {{ error }}
        </div>
        <button class="btn btn-outline-danger mt-2" (click)="cargarReclamos()">
            Reintentar
        </button>
    </div>

    <!-- Tabla de reclamos -->
    <div *ngIf="!cargando && !error" class="card">
        <!-- Info de resultados -->
        <div class="card-header bg-light" *ngIf="paginacion">
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">
                    Mostrando {{ paginacion.from }} - {{ paginacion.to }} de {{ paginacion.total }} reclamos
                </small>
                <small class="text-muted">
                    P√°gina {{ paginacion.current_page }} de {{ paginacion.last_page }}
                </small>
            </div>
        </div>

        <!-- Tabla -->
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>N¬∞ Reclamo</th>
                        <th>Cliente</th>
                        <th>Documento</th>
                        <th>Tipo</th>
                        <th>Estado</th>
                        <th>Fecha</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let reclamo of reclamos">
                        <!-- N√∫mero -->
                        <td>
                            <code class="text-primary fw-bold">{{ reclamo.numero_reclamo }}</code>
                        </td>

                        <!-- Cliente -->
                        <td>
                            <div>
                                <div class="fw-semibold">{{ getNombreCompleto(reclamo) }}</div>
                                <small class="text-muted" *ngIf="reclamo.email">{{ reclamo.email }}</small>
                            </div>
                        </td>

                        <!-- Documento -->
                        <td>
                            <code class="text-muted">{{ reclamo.numero_documento }}</code>
                        </td>

                        <!-- Tipo -->
                        <td>
                            <span class="badge" 
                                  [class]="reclamo.tipo_reclamo === 'reclamo' ? 'bg-danger' : 'bg-secondary'">
                                {{ reclamo.tipo_reclamo | titlecase }}
                            </span>
                        </td>

                        <!-- Estado -->
                        <td>
                            <span class="badge" 
                                  [class]="reclamo.estado === 'pendiente' ? 'bg-warning text-dark' : 
                                           reclamo.estado === 'en_proceso' ? 'bg-info' : 'bg-success'">
                                {{ reclamo.estado === 'en_proceso' ? 'En Proceso' : (reclamo.estado | titlecase) }}
                            </span>
                        </td>

                        <!-- Fecha -->
                        <td>
                            <small class="text-muted">{{ formatearFecha(reclamo.created_at) }}</small>
                        </td>

                        <!-- Acciones -->
                        <td class="text-center">
                            <button class="btn btn-outline-primary btn-sm" 
                                    (click)="verDetalle(reclamo)"
                                    title="Ver detalle">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                        </td>
                    </tr>

                    <!-- Estado vac√≠o -->
                    <tr *ngIf="reclamos.length === 0">
                        <td colspan="7" class="text-center py-5">
                            <div class="text-muted">
                                <div class="display-1 mb-3">üìù</div>
                                <h4>No hay reclamos</h4>
                                <p>No se encontraron reclamos con los filtros aplicados.</p>
                                <button class="btn btn-primary" (click)="limpiarFiltros()">
                                    Ver todos los reclamos
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Paginaci√≥n -->
        <div *ngIf="paginacion && paginacion.last_page > 1" class="card-footer">
            <nav>
                <ul class="pagination justify-content-center mb-0">
                    <li class="page-item" [class.disabled]="paginacion.current_page === 1">
                        <button class="page-link" 
                                (click)="cambiarPagina(paginacion.current_page - 1)"
                                [disabled]="paginacion.current_page === 1">
                            Anterior
                        </button>
                    </li>
                    
                    <li *ngFor="let pagina of getPaginasVisibles()" 
                        class="page-item"
                        [class.active]="pagina === paginacion.current_page"
                        [class.disabled]="pagina === -1">
                        <button class="page-link" 
                                (click)="cambiarPagina(pagina)"
                                [disabled]="pagina === -1">
                            <span *ngIf="pagina !== -1">{{ pagina }}</span>
                            <span *ngIf="pagina === -1">...</span>
                        </button>
                    </li>
                    
                    <li class="page-item" [class.disabled]="paginacion.current_page === paginacion.last_page">
                        <button class="page-link" 
                                (click)="cambiarPagina(paginacion.current_page + 1)"
                                [disabled]="paginacion.current_page === paginacion.last_page">
                            Siguiente
                        </button>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <!-- Modal de detalle -->
    <div *ngIf="mostrandoDetalle && reclamoSeleccionado" 
         class="modal d-block" tabindex="-1" 
         style="background-color: rgba(0,0,0,0.5);"
         (click)="cerrarDetalle()">
        <div class="modal-dialog modal-xl modal-dialog-scrollable" (click)="$event.stopPropagation()">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        üîç Detalle del Reclamo {{ reclamoSeleccionado.numero_reclamo }}
                    </h5>
                    <button type="button" class="btn-close" (click)="cerrarDetalle()"></button>
                </div>

                <div class="modal-body">
                    <div class="row g-4">
                        <!-- Informaci√≥n del cliente -->
                        <div class="col-lg-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">üë§ Informaci√≥n del Cliente</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Nombre completo:</label>
                                        <p class="mb-0">{{ getNombreCompleto(reclamoSeleccionado) }}</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Documento:</label>
                                        <p class="mb-0">{{ reclamoSeleccionado.tipo_documento | uppercase }} - {{ reclamoSeleccionado.numero_documento }}</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Email:</label>
                                        <p class="mb-0">{{ reclamoSeleccionado.email }}</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Tel√©fono:</label>
                                        <p class="mb-0">{{ reclamoSeleccionado.telefono }}</p>
                                    </div>
                                    <div class="mb-0">
                                        <label class="form-label fw-semibold">Direcci√≥n:</label>
                                        <p class="mb-0">{{ reclamoSeleccionado.direccion }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Informaci√≥n del reclamo -->
                        <div class="col-lg-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">üìã Informaci√≥n del Reclamo</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Tipo:</label>
                                        <div>
                                            <span class="badge" 
                                                  [class]="reclamoSeleccionado.tipo_reclamo === 'reclamo' ? 'bg-danger' : 'bg-secondary'">
                                                {{ reclamoSeleccionado.tipo_reclamo | titlecase }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Estado:</label>
                                        <div>
                                            <span class="badge" 
                                                  [class]="reclamoSeleccionado.estado === 'pendiente' ? 'bg-warning text-dark' : 
                                                           reclamoSeleccionado.estado === 'en_proceso' ? 'bg-info' : 'bg-success'">
                                                {{ reclamoSeleccionado.estado | titlecase }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Fecha del incidente:</label>
                                        <p class="mb-0">{{ reclamoSeleccionado.fecha_incidente | date:'dd/MM/yyyy' }}</p>
                                    </div>
                                    <div class="mb-0">
                                        <label class="form-label fw-semibold">Monto reclamado:</label>
                                        <p class="mb-0">
                                            <span *ngIf="reclamoSeleccionado.monto_reclamado">
                                                {{ formatearMonto(reclamoSeleccionado.monto_reclamado) }}
                                            </span>
                                            <span *ngIf="!reclamoSeleccionado.monto_reclamado" class="text-muted">
                                                No especificado
                                            </span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bien o servicio -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">üõçÔ∏è Bien o Servicio</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label fw-semibold">Tipo:</label>
                                                <p class="mb-0">{{ reclamoSeleccionado.tipo_bien | titlecase }}</p>
                                            </div>
                                        </div>
                                        <div class="col-md-6" *ngIf="reclamoSeleccionado.pedido_concreto">
                                            <div class="mb-3">
                                                <label class="form-label fw-semibold">Pedido espec√≠fico:</label>
                                                <p class="mb-0">{{ reclamoSeleccionado.pedido_concreto }}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-0">
                                        <label class="form-label fw-semibold">Descripci√≥n:</label>
                                        <div class="border p-3 bg-light rounded">
                                            <p class="mb-0">{{ reclamoSeleccionado.descripcion_bien }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Detalle del reclamo -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">üìù Detalle del {{ reclamoSeleccionado.tipo_reclamo | titlecase }}</h6>
                                </div>
                                <div class="card-body">
                                    <div class="border p-3 bg-light rounded">
                                        <p class="mb-0">{{ reclamoSeleccionado.detalle_reclamo }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Fechas -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">üìÖ Fechas</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label fw-semibold">Fecha de registro:</label>
                                            <p class="mb-0">{{ formatearFecha(reclamoSeleccionado.created_at) }}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-semibold">√öltima actualizaci√≥n:</label>
                                            <p class="mb-0">{{ formatearFecha(reclamoSeleccionado.updated_at) }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <div class="d-flex align-items-center gap-3">
                        <label class="form-label fw-semibold mb-0">Cambiar estado:</label>
                        <select class="form-select" 
                                style="width: auto;"
                                [value]="reclamoSeleccionado.estado"
                                (change)="actualizarEstado(reclamoSeleccionado, estadoSelect.value)"
                                [disabled]="actualizandoEstado"
                                #estadoSelect>
                            <option value="pendiente">Pendiente</option>
                            <option value="en_proceso">En Proceso</option>
                            <option value="resuelto">Resuelto</option>
                        </select>
                        <span *ngIf="actualizandoEstado" class="text-muted">
                            <div class="spinner-border spinner-border-sm me-1"></div>
                            Actualizando...
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>